---
phase: 01-content-foundation
plan: 02
type: execute
---

<objective>
Clean up technical debt identified in codebase analysis to establish clean foundation for content enhancements.

Purpose: Remove hardcoded URLs and extract duplicate logic before adding new features. This prevents compounding tech debt and makes future content improvements safer and easier.
Output: Centralized URL configuration, reusable structured data utilities, consistent string helpers - reducing duplication from 20+ locations to single source of truth.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/codebase/CONCERNS.md
@.planning/codebase/CONVENTIONS.md
@src/lib/urlUtils.ts
@astro.config.mjs

**Tech debt from CONCERNS.md**:
1. Hardcoded domain `https://www.parrotspeciesguide.com` in 20+ locations
2. Duplicate `.replace(/</g, '\\u003c')` pattern in 10+ files
3. Inconsistent string truncation (`.substring(0, 150)` vs `.slice(0, 120)`)

**Current patterns**:
- `astro.config.mjs` has `site` config but not being used
- `src/lib/urlUtils.ts` exists with `toAbsoluteUrl()` function
- Manual JSON-LD escaping repeated in every page file
- No utility for string truncation with ellipsis

**Fix approach**:
- Use Astro's `import.meta.env.SITE` and `Astro.site.href`
- Create `src/lib/structuredData.ts` for JSON-LD utilities
- Create `src/lib/stringUtils.ts` for text helpers
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create structured data and string utility modules</name>
  <files>src/lib/structuredData.ts, src/lib/stringUtils.ts</files>
  <action>
Create `src/lib/structuredData.ts`:
```typescript
/**
 * Escapes JSON for safe embedding in HTML script tags
 * Prevents XSS by escaping < characters that could break out of script context
 */
export function escapeJsonLd(data: object): string {
  return JSON.stringify(data).replace(/</g, '\\u003c');
}
```

Create `src/lib/stringUtils.ts`:
```typescript
/**
 * Truncates text to specified length, appending ellipsis only if truncated
 * @param text - Text to truncate
 * @param maxLength - Maximum length before truncation (default: 150)
 * @returns Truncated text with ellipsis if shortened, original if within limit
 */
export function truncateWithEllipsis(text: string, maxLength: number = 150): string {
  if (!text || text.length <= maxLength) {
    return text;
  }
  return text.slice(0, maxLength) + '...';
}
```

Follow codebase conventions: camelCase functions, named exports, JSDoc comments, single quotes in TypeScript. Add explicit return types.

DO NOT modify any other files yet - just create the utility modules.
  </action>
  <verify>Files created, npm run astro check passes, utilities export correctly</verify>
  <done>Two new utility modules created with documented functions, ready for adoption</done>
</task>

<task type="auto">
  <name>Task 2: Update urlUtils to use Astro site configuration</name>
  <files>src/lib/urlUtils.ts</files>
  <action>
Replace hardcoded `https://www.parrotspeciesguide.com` with dynamic site URL from Astro config.

Change the `toAbsoluteUrl` function to accept optional `siteUrl` parameter:
```typescript
export function toAbsoluteUrl(path: string, siteUrl: string = 'https://www.parrotspeciesguide.com'): string {
  // existing normalization logic
  return `${siteUrl}${normalized}`;
}
```

Add JSDoc comment explaining:
- Function reads site URL from Astro.site when available
- Falls back to env variable or hardcoded default
- Callers should pass `Astro.site?.href` from page context

Keep the fallback temporarily during migration. We'll remove it in Task 3 once all callers are updated.

DO NOT update call sites yet - that's for later plans when we touch each page file for content improvements.
  </action>
  <verify>Function signature updated, JSDoc added, astro check passes, function still works with default</verify>
  <done>urlUtils.ts prepared for centralized URL management, backward compatible during migration</done>
</task>

<task type="auto">
  <name>Task 3: Add migration note and verify utilities</name>
  <files>src/lib/structuredData.ts, src/lib/stringUtils.ts, src/lib/urlUtils.ts</files>
  <action>
Add file header comments to all three utility modules explaining:
```typescript
/**
 * [Module Purpose]
 *
 * Migration Note: Created during Phase 1 to reduce duplication.
 * Existing pages will be migrated to use these utilities in subsequent plans.
 */
```

Run full validation:
1. `npm run astro check` - Type checking
2. `npm run build` - Verify no build regressions
3. Check all utilities are exported correctly

Create simple test file (even though no test framework exists) showing example usage:
`src/lib/__examples__.ts` with:
- Import statements for all three utilities
- Example calls showing expected input/output
- Comment noting "Delete this file after migration complete"

DO NOT wire up utilities to actual pages yet - that would touch 10+ files and exceed our 3-task limit. Pages will be updated in Plan 03.
  </action>
  <verify>All utilities documented, build passes, examples file demonstrates correct usage</verify>
  <done>Utility modules complete and validated, ready for gradual adoption across codebase</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Three utility modules exist: `structuredData.ts`, `stringUtils.ts`, updated `urlUtils.ts`
- [ ] All functions have JSDoc documentation
- [ ] `escapeJsonLd` function handles JSON-LD escaping
- [ ] `truncateWithEllipsis` function has length check and only appends ellipsis when needed
- [ ] `toAbsoluteUrl` function accepts optional siteUrl parameter
- [ ] `npm run build` succeeds with no errors
- [ ] Examples file demonstrates usage patterns
</verification>

<success_criteria>

- Utility modules created following codebase conventions
- All functions properly documented with JSDoc
- Backward compatible with existing code
- Build confirms no regressions
- Foundation laid for removing duplication in later plans
  </success_criteria>

<output>
After completion, create `.planning/phases/01-content-foundation/01-02-SUMMARY.md`
</output>
