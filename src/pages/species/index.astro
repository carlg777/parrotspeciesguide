---
export const prerender = true;
import BaseLayout from "../../layouts/BaseLayout.astro";
import { getCollection } from 'astro:content';
import { toAbsoluteUrl } from '../../lib/urlUtils';
import { Image } from 'astro:assets';
import { getImageImport } from '../../lib/imageImport';
import { getLangFromUrl } from '../../i18n/utils';

// Get current language
const currentLang = getLangFromUrl(Astro.url);

// Get all species
const allSpecies = await getCollection('species');

// Sort alphabetically by species name in current language
const sortedSpecies = allSpecies.sort((a, b) =>
  a.data.species[currentLang].localeCompare(b.data.species[currentLang])
);

// Get unique categories
const categories = [...new Set(allSpecies.map(s => s.data.category))].sort();

// Get unique origins in current language
const origins = [...new Set(allSpecies.map(s => s.data.origin[currentLang]))].sort();

const categoryGroups = categories.map(category => ({
  category,
  slug: category.toLowerCase().replace(/\s+/g, "-"),
  species: sortedSpecies.filter(entry => entry.data.category === category)
}));

// Serialize for client-side filtering
const serializedSpecies = JSON.stringify(sortedSpecies.map(s => s.data)).replace(/</g, '\\u003c');

// ItemList structured data
const speciesListStructuredData = {
  "@context": "https://schema.org",
  "@type": "ItemList",
  "name": "Parrot Species Care Guides",
  "description": "Complete care guides for 84 parrot species including temperament, diet, housing, and health information.",
  "numberOfItems": sortedSpecies.length,
  "itemListElement": sortedSpecies.map((species, index) => ({
    "@type": "ListItem",
    "position": index + 1,
    "url": `https://www.parrotspeciesguide.com/species/${species.data.slug}`,
    "name": species.data.species[currentLang],
    "image": toAbsoluteUrl(species.data.image)
  }))
};

const speciesListDataString = JSON.stringify(speciesListStructuredData).replace(/</g, '\\u003c');

const faqStructuredData = {
  "@context": "https://schema.org",
  "@type": "FAQPage",
  "mainEntity": [
    {
      "@type": "Question",
      "name": "How many parrot species are in this guide?",
      "acceptedAnswer": {
        "@type": "Answer",
        "text": `This guide includes ${sortedSpecies.length} detailed parrot species profiles.`
      }
    },
    {
      "@type": "Question",
      "name": "Can I filter by noise level?",
      "acceptedAnswer": {
        "@type": "Answer",
        "text": "Yes. Use the noise level filter to find quiet, moderate, loud, or very loud species."
      }
    },
    {
      "@type": "Question",
      "name": "Do you list beginner-friendly parrots?",
      "acceptedAnswer": {
        "@type": "Answer",
        "text": "Yes. Use the Quick Facts buttons to see beginner-friendly options and other quick filters."
      }
    }
  ]
};

const faqDataString = JSON.stringify(faqStructuredData).replace(/</g, '\\u003c');
---

<BaseLayout
  title="Parrot Species Guide | Species List"
  description="Explore detailed profiles of 80+ parrot species. Learn about temperament, care requirements, noise levels, and more for Macaws, Cockatoos, Amazons, African Greys, and other pet parrots."
  canonical="https://www.parrotspeciesguide.com/species"
  ogTitle="Complete Parrot Species Guide"
  ogDescription="Discover the perfect parrot species for your home. Detailed care information, temperament profiles, and expert guidance."
  dataPage="species"
>
  <Fragment slot="head">
    <script type="application/ld+json" is:inline>
      {speciesListDataString}
    </script>
    <script type="application/ld+json" is:inline>
      {faqDataString}
    </script>
  </Fragment>
  <main class="container page-main page-main--compact">
    <header class="page-header">
      <h1 class="page-title">
        Parrot Species Guide
      </h1>
      <p class="page-subtitle">
        Explore {allSpecies.length} parrot species with detailed care information
      </p>
    </header>

    <!-- Quick Facts -->
    <section class="section-gap">
      <h2 class="section-title section-title--center">
        Quick Facts
      </h2>
      <div class="button-row">
        <button class="button button-secondary" data-quick-fact="quiet">Quietest Species</button>
        <button class="button button-secondary" data-quick-fact="talkers">Best Talkers</button>
        <button class="button button-secondary" data-quick-fact="beginner">Beginner-Friendly</button>
        <button class="button button-secondary" data-quick-fact="demanding">Most Demanding</button>
        <button class="button button-secondary" data-quick-fact="small">Small Parrots</button>
        <button class="button button-secondary" data-quick-fact="apartment">Apartment Friendly</button>
      </div>
    </section>

    <!-- Search and Filters -->
    <section class="search-filters filter-panel">
      <div class="filter-grid">
        <div class="field-group">
          <label for="species-search">Search Species</label>
          <input
            type="text"
            id="species-search"
            placeholder="Search by name..."
            class="input-control"
          />
        </div>

        <div class="field-group">
          <label for="filter-origin">Filter by Origin</label>
          <select
            id="filter-origin"
            class="input-control"
          >
            <option value="">All Regions</option>
            {origins.map(origin => (
              <option value={origin}>{origin}</option>
            ))}
          </select>
        </div>

        <div class="field-group">
          <label for="filter-loudness">Filter by Noise Level</label>
          <select
            id="filter-loudness"
            class="input-control"
          >
            <option value="">All Levels</option>
            <option value="Quiet">Quiet</option>
            <option value="Moderate">Moderate</option>
            <option value="Loud">Loud</option>
            <option value="Very Loud">Very Loud</option>
          </select>
        </div>
      </div>

      <div class="results-count">
        <span id="results-count">{allSpecies.length} species</span>
      </div>
    </section>

    <!-- FAQ -->
    <section class="faq-section">
      <h2 class="section-title section-title--center section-title--lg">
        Parrot Species FAQ
      </h2>
      <div class="faq-grid">
        <div class="filters-panel__card">
          <h3 class="faq-question">How many parrot species are in this guide?</h3>
          <p class="faq-answer">
            This guide includes {sortedSpecies.length} detailed parrot species profiles.
          </p>
        </div>
        <div class="filters-panel__card">
          <h3 class="faq-question">Can I filter by noise level?</h3>
          <p class="faq-answer">
            Yes. Use the noise level filter to find quiet, moderate, loud, or very loud species.
          </p>
        </div>
        <div class="filters-panel__card">
          <h3 class="faq-question">Do you list beginner-friendly parrots?</h3>
          <p class="faq-answer">
            Yes. Use the Quick Facts buttons to see beginner-friendly options and other quick filters.
          </p>
        </div>
      </div>
    </section>

    <!-- Species by Category -->
    <div id="species-grid" class="species-grid">
      {categoryGroups.map(group => (
        <section id={group.slug} class="species-category" data-category={group.category}>
          <h2 class="section-title section-title--lg">
            {group.category}
          </h2>
          <div class="featured-grid species-category__grid">
            {group.species.map((speciesEntry) => (
              <article class="filters-panel__card species-card" data-species={speciesEntry.data.slug}>
                <a href={`/species/${speciesEntry.data.slug}`} class="species-card__link">
                  <div class="species-card__media">
                    <Image
                      src={getImageImport(speciesEntry.data.image)}
                      alt={`${speciesEntry.data.species[currentLang]} parrot from ${speciesEntry.data.origin[currentLang]} - ${speciesEntry.data.size[currentLang]}`}
                      loading="lazy"
                      decoding="async"
                      widths={[300, 600]}
                      sizes="(max-width: 480px) 100vw, 300px"
                      class="species-card__image"
                    />
                  </div>

                  <h3 class="species-card__title">
                    {speciesEntry.data.species[currentLang]}
                  </h3>

                  <p class="species-card__meta">
                    {speciesEntry.data.category}
                  </p>

                  <div class="species-card__badges">
                    <span class="badge badge-success badge--small">
                      {speciesEntry.data.origin[currentLang]}
                    </span>
                    <span class={`badge badge--small ${speciesEntry.data.loudness[currentLang].includes('Quiet') ? 'badge-success' : speciesEntry.data.loudness[currentLang].includes('Loud') ? 'badge-accent' : ''}`}>
                      {speciesEntry.data.loudness[currentLang]}
                    </span>
                  </div>

                  <p class="species-card__excerpt">
                    {speciesEntry.data.description[currentLang].substring(0, 150)}...
                  </p>

                  <div class="species-card__cta">
                    <span class="species-card__cta-text">Learn more â†’</span>
                  </div>
                </a>
              </article>
            ))}
          </div>
        </section>
      ))}
    </div>

    <!-- No Results Message -->
    <div id="no-results" class="no-results">
      <p class="no-results__text">
        No species match your filters. Try adjusting your search.
      </p>
    </div>
  </main>

  <script is:inline define:vars={{ serializedSpecies }}>
    const speciesData = JSON.parse(serializedSpecies);
    const searchInput = document.getElementById('species-search');
    const originFilter = document.getElementById('filter-origin');
    const loudnessFilter = document.getElementById('filter-loudness');
    const resultsCount = document.getElementById('results-count');
    const speciesCards = document.querySelectorAll('.species-card');
    const categorySections = document.querySelectorAll('.species-category');
    const noResults = document.getElementById('no-results');
    const quickFactButtons = document.querySelectorAll('[data-quick-fact]');

    function filterSpecies() {
      const searchTerm = searchInput.value.toLowerCase().trim();
      const origin = originFilter.value;
      const loudness = loudnessFilter.value;

      let visibleCount = 0;

      speciesCards.forEach(card => {
        const slug = card.getAttribute('data-species');
        const species = speciesData.find(s => s.slug === slug);

        if (!species) {
          card.style.display = 'none';
          return;
        }

        // Split search terms by space and check if ANY term matches
        const searchTerms = searchTerm.split(/\s+/).filter(t => t.length > 0);
        const matchesSearch = searchTerms.length === 0 || searchTerms.some(term =>
          species.species[currentLang].toLowerCase().includes(term) ||
          species.category.toLowerCase().includes(term) ||
          species.description[currentLang].toLowerCase().includes(term)
        );

        const matchesOrigin = !origin || species.origin[currentLang] === origin;
        const matchesLoudness = !loudness || species.loudness[currentLang].includes(loudness);

        if (matchesSearch && matchesOrigin && matchesLoudness) {
          card.style.display = '';
          visibleCount++;
        } else {
          card.style.display = 'none';
        }
      });

      resultsCount.textContent = `${visibleCount} species`;
      noResults.style.display = visibleCount === 0 ? 'block' : 'none';

      categorySections.forEach(section => {
        const cards = section.querySelectorAll('.species-card');
        const hasVisible = Array.from(cards).some(card => card.style.display !== 'none');
        section.style.display = hasVisible ? '' : 'none';
      });
    }

    // Quick fact filters
    quickFactButtons.forEach(button => {
      button.addEventListener('click', () => {
        const fact = button.getAttribute('data-quick-fact');

        // Clear all filters first
        searchInput.value = '';
        originFilter.value = '';
        loudnessFilter.value = '';

        // Set the appropriate filter
        switch(fact) {
          case 'quiet':
            loudnessFilter.value = 'Quiet';
            break;
          case 'talkers':
            // Best talking species: African Greys and top Amazon talkers
            searchInput.value = 'congo timneh yellow-naped blue-fronted double';
            break;
          case 'beginner':
            // Easy-going, forgiving species good for first-time owners
            searchInput.value = 'budgerigar cockatiel';
            break;
          case 'demanding':
            searchInput.value = 'macaw cockatoo';
            break;
          case 'small':
            // All small species regardless of difficulty
            searchInput.value = 'parakeet parrotlet lovebird budgerigar conure caique';
            break;
          case 'apartment':
            // Quiet, smaller species ideal for apartment living
            searchInput.value = 'bourke budgerigar cockatiel pionus parrotlet lineolated lovebird';
            break;
        }

        filterSpecies();
      });
    });

    searchInput.addEventListener('input', filterSpecies);
    originFilter.addEventListener('change', filterSpecies);
    loudnessFilter.addEventListener('change', filterSpecies);
  </script>
</BaseLayout>
