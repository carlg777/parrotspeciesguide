---
export const prerender = true;
import BaseLayout from "../../layouts/BaseLayout.astro";
import { getCollection } from 'astro:content';
import { toAbsoluteUrl } from '../../lib/urlUtils';

export async function getStaticPaths() {
  const allSpecies = await getCollection('species');
  return allSpecies.map(species => ({
    params: { slug: species.data.slug },
    props: { species: species.data },
  }));
}

const { species } = Astro.props;

const categorySlug = species.category.toLowerCase().replace(/\s+/g, "-");

// Get related species (same category)
const allSpecies = await getCollection('species');
const relatedSpecies = allSpecies
  .filter(s => s.data.category === species.category && s.data.slug !== species.slug)
  .slice(0, 3);

// Structured data for SEO
const structuredData = {
  "@context": "https://schema.org",
  "@type": "Article",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": `https://www.parrotspeciesguide.com/species/${species.slug}`
  },
  "headline": `${species.species} - Complete Care Guide`,
  "description": species.description,
  "image": toAbsoluteUrl(species.image),
  "author": {
    "@type": "Organization",
    "name": "Parrot Species Guide"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Parrot Species Guide",
    "logo": {
      "@type": "ImageObject",
      "url": toAbsoluteUrl("/assets/img/brand/psg-logo.svg")
    }
  },
  "mainEntity": {
    "@type": "Animal",
    "name": species.species,
    "image": toAbsoluteUrl(species.image),
    "description": species.description
  }
};

// Breadcrumb structured data
const breadcrumbStructuredData = {
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position": 1,
      "name": "Home",
      "item": "https://www.parrotspeciesguide.com/"
    },
    {
      "@type": "ListItem",
      "position": 2,
      "name": "Species Guide",
      "item": "https://www.parrotspeciesguide.com/species"
    },
    {
      "@type": "ListItem",
      "position": 3,
      "name": species.species,
      "item": `https://www.parrotspeciesguide.com/species/${species.slug}`
    }
  ]
};

const structuredDataString = JSON.stringify(structuredData).replace(/</g, '\\u003c');
const breadcrumbDataString = JSON.stringify(breadcrumbStructuredData).replace(/</g, '\\u003c');
---

<BaseLayout
  title={`${species.species} | Parrot Species Guide`}
  description={`${species.description.substring(0, 150)}. Learn about care, temperament, diet, and housing for ${species.species}.`}
  canonical={`https://www.parrotspeciesguide.com/species/${species.slug}`}
  ogTitle={`${species.species} - Complete Care Guide`}
  ogDescription={species.description.substring(0, 200)}
  ogImage={species.image}
  dataPage="species-detail"
>
  <Fragment slot="head">
    <link rel="preload" as="image" href={species.image} type="image/webp" />
    <script type="application/ld+json" is:inline>
      {structuredDataString}
    </script>
    <script type="application/ld+json" is:inline>
      {breadcrumbDataString}
    </script>
  </Fragment>

  <main class="container" style="padding: 2rem 0 4rem;">
    <!-- Breadcrumbs -->
    <nav aria-label="Breadcrumb" style="margin-bottom: 2rem;">
      <ol style="display: flex; gap: 0.5rem; list-style: none; padding: 0; margin: 0; font-size: 0.9rem; color: var(--pf-neutral-500);">
        <li><a href="/" style="color: var(--pf-primary-600);">Home</a></li>
        <li>›</li>
        <li><a href="/species" style="color: var(--pf-primary-600);">Species Guide</a></li>
        <li>›</li>
        <li>{species.species}</li>
      </ol>
    </nav>

    <div style="display: flex; flex-wrap: wrap; gap: 0.75rem; margin: 0 0 2rem;">
      <a href="/species" class="badge" style="text-decoration: none; color: var(--pf-primary-600); border: 1px solid var(--pf-primary-200);">
        Back to all species
      </a>
      <a href={`/species#${categorySlug}`} class="badge" style="text-decoration: none; color: var(--pf-primary-600); border: 1px solid var(--pf-primary-200);">
        More {species.category}
      </a>
    </div>

    <div style="display: grid; grid-template-columns: 1fr; gap: 3rem; max-width: 1000px; margin: 0 auto;">
      <!-- Hero Section -->
      <section style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; align-items: start;">
        <div style="position: relative; border-radius: var(--pf-radius-soft); overflow: hidden;">
          <img
            src={species.image}
            alt={`${species.species} parrot - ${species.description.substring(0, 100)}...`}
            loading="eager"
            fetchpriority="high"
            decoding="async"
            style="width: 100%; height: auto; display: block;"
            width="800"
            height="600"
          />
        </div>

        <div>
          <span class="badge badge-success" style="margin-bottom: 1rem; display: inline-block;">
            {species.category}
          </span>

          <h1 style="font-family: var(--pf-font-display); font-size: 2.5rem; margin: 0 0 1rem;">
            {species.species}
          </h1>

          <p style="color: var(--pf-neutral-700); line-height: 1.6; font-size: 1.1rem; margin-bottom: 2rem;">
            {species.description}
          </p>

          <!-- Quick Stats -->
          <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; margin-bottom: 2rem;">
            <div class="filters-panel__card" style="padding: 1rem;">
              <div style="color: var(--pf-neutral-500); font-size: 0.85rem; margin-bottom: 0.25rem;">Origin</div>
              <div style="font-weight: 600; color: var(--pf-neutral-900);">{species.origin}</div>
            </div>

            <div class="filters-panel__card" style="padding: 1rem;">
              <div style="color: var(--pf-neutral-500); font-size: 0.85rem; margin-bottom: 0.25rem;">Size</div>
              <div style="font-weight: 600; color: var(--pf-neutral-900);">{species.size}</div>
            </div>

            <div class="filters-panel__card" style="padding: 1rem;">
              <div style="color: var(--pf-neutral-500); font-size: 0.85rem; margin-bottom: 0.25rem;">Weight</div>
              <div style="font-weight: 600; color: var(--pf-neutral-900);">{species.weight_grams}g avg.</div>
            </div>

            <div class="filters-panel__card" style="padding: 1rem;">
              <div style="color: var(--pf-neutral-500); font-size: 0.85rem; margin-bottom: 0.25rem;">Noise Level</div>
              <div style="font-weight: 600; color: var(--pf-neutral-900);">{species.loudness}</div>
            </div>
          </div>

          <!-- CTA to Browse -->
          <div style="background: var(--pf-primary-050); border: 1px solid var(--pf-primary-500); border-radius: var(--pf-radius-soft); padding: 1.5rem; text-align: center;">
            <p style="margin: 0 0 1rem; color: var(--pf-neutral-700); font-weight: 500;">
              Looking for a {species.species}?
            </p>
            <a href={`/browse?search=${encodeURIComponent(species.species)}`} class="button button-primary">
              See Available {species.species} Listings
            </a>
          </div>
        </div>
      </section>

      <!-- Detailed Information -->
      <section style="display: grid; gap: 2rem;">
        <!-- Temperament -->
        <div class="filters-panel__card">
          <h2 style="font-family: var(--pf-font-display); font-size: 1.5rem; margin: 0 0 1rem;">
            Temperament & Personality
          </h2>
          <p style="color: var(--pf-neutral-700); line-height: 1.6; margin: 0;">
            {species.temperament}
          </p>
        </div>

        <!-- Vocalization -->
        <div class="filters-panel__card">
          <h2 style="font-family: var(--pf-font-display); font-size: 1.5rem; margin: 0 0 1rem;">
            Vocalization & Talking Ability
          </h2>
          <p style="color: var(--pf-neutral-700); line-height: 1.6; margin: 0;">
            {species.vocalization}
          </p>
        </div>

        <!-- Diet -->
        <div class="filters-panel__card">
          <h2 style="font-family: var(--pf-font-display); font-size: 1.5rem; margin: 0 0 1rem;">
            Dietary Needs
          </h2>
          <div style="color: var(--pf-neutral-700); line-height: 1.6;" set:html={species.dietaryNeeds} />
        </div>

        <!-- Health -->
        <div class="filters-panel__card">
          <h2 style="font-family: var(--pf-font-display); font-size: 1.5rem; margin: 0 0 1rem;">
            Health & Lifespan
          </h2>
          <div style="color: var(--pf-neutral-700); line-height: 1.6;" set:html={species.healthPointers} />
        </div>

        <!-- Housing -->
        <div class="filters-panel__card">
          <h2 style="font-family: var(--pf-font-display); font-size: 1.5rem; margin: 0 0 1rem;">
            Housing Requirements
          </h2>
          <div style="color: var(--pf-neutral-700); line-height: 1.6;" set:html={species.housing} />
        </div>
      </section>

      <!-- Related Species -->
      {relatedSpecies.length > 0 && (
        <section>
          <h2 style="font-family: var(--pf-font-display); font-size: 1.75rem; margin: 0 0 1.5rem;">
            More {species.category}
          </h2>
          <div class="featured-grid" style="grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));">
            {relatedSpecies.map((related) => (
              <article class="filters-panel__card">
                <a href={`/species/${related.data.slug}`} style="text-decoration: none; color: inherit;">
                  <div style="position: relative; padding-bottom: 66.67%; overflow: hidden; border-radius: var(--pf-radius-soft); margin-bottom: 1rem;">
                    <img
                      src={related.data.image}
                      alt={related.data.species}
                      loading="lazy"
                      decoding="async"
                      style="position: absolute; width: 100%; height: 100%; object-fit: cover;"
                    />
                  </div>
                  <h3 style="font-family: var(--pf-font-display); font-size: 1.1rem; margin: 0 0 0.5rem;">
                    {related.data.species}
                  </h3>
                  <p style="color: var(--pf-neutral-500); font-size: 0.9rem; margin: 0;">
                    {related.data.loudness}
                  </p>
                </a>
              </article>
            ))}
          </div>
          <div style="margin-top: 1.5rem;">
            <a href={`/species#${categorySlug}`} class="button button-secondary">
              View all {species.category}
            </a>
          </div>
        </section>
      )}
    </div>
  </main>
</BaseLayout>

<style>
  @media (max-width: 768px) {
    section > div[style*="grid-template-columns: 1fr 1fr"] {
      grid-template-columns: 1fr !important;
    }

    section > div[style*="grid-template-columns: repeat(2, 1fr)"] {
      grid-template-columns: 1fr !important;
    }
  }
</style>
