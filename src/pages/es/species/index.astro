---
export const prerender = true;
import BaseLayout from "../../../layouts/BaseLayout.astro";
import { getCollection } from 'astro:content';
import { toAbsoluteUrl } from '../../../lib/urlUtils';

// Get all species
const allSpecies = await getCollection('species');

// Sort alphabetically
const sortedSpecies = allSpecies.sort((a, b) =>
  a.data.species.localeCompare(b.data.species)
);

// Get unique categories
const categories = [...new Set(allSpecies.map(s => s.data.category))].sort();

// Get unique origins
const origins = [...new Set(allSpecies.map(s => s.data.origin))].sort();

// Serialize for client-side filtering
const serializedSpecies = JSON.stringify(sortedSpecies.map(s => s.data)).replace(/</g, '\\u003c');

// ItemList structured data
const speciesListStructuredData = {
  "@context": "https://schema.org",
  "@type": "ItemList",
  "name": "Guías de Cuidado de Especies de Loros",
  "description": "Guías completas de cuidado para 84 especies de loros incluyendo temperamento, dieta, alojamiento e información de salud.",
  "numberOfItems": sortedSpecies.length,
  "itemListElement": sortedSpecies.map((species, index) => ({
    "@type": "ListItem",
    "position": index + 1,
    "url": `https://www.findyourparrot.com/es/species/${species.data.slug}`,
    "name": species.data.species,
    "image": toAbsoluteUrl(species.data.image)
  }))
};

const speciesListDataString = JSON.stringify(speciesListStructuredData).replace(/</g, '\\u003c');
---

<BaseLayout
  title="Guía de Especies de Loros | Encuentra Tu Loro"
  description="Explora perfiles detallados de más de 80 especies de loros. Aprende sobre temperamento, requisitos de cuidado, niveles de ruido y más para Guacamayos, Cacatúas, Amazonas, Grises Africanos y otros loros domésticos."
  canonical="https://www.findyourparrot.com/es/species"
  ogTitle="Guía Completa de Especies de Loros"
  ogDescription="Descubre la especie de loro perfecta para tu hogar. Información detallada de cuidado, perfiles de temperamento y orientación experta."
  dataPage="species"
>
  <Fragment slot="head">
    <script type="application/ld+json" is:inline>
      {speciesListDataString}
    </script>
  </Fragment>
  <main class="container" style="padding: 2rem 0 4rem;">
    <header style="text-align: center; margin-bottom: 3rem;">
      <h1 style="font-family: var(--pf-font-display); font-size: 2.5rem; margin: 0;">
        Guía de Especies de Loros
      </h1>
      <p style="color: var(--pf-neutral-500); margin: 0.75rem 0 0; font-size: 1.1rem;">
        Explora {allSpecies.length} especies de loros con información detallada de cuidado
      </p>
    </header>

    <!-- Quick Facts -->
    <section style="margin-bottom: 3rem;">
      <h2 style="font-family: var(--pf-font-display); font-size: 1.5rem; text-align: center; margin-bottom: 1.5rem;">
        Datos Rápidos
      </h2>
      <div style="display: flex; flex-wrap: wrap; justify-content: center; gap: 0.75rem;">
        <button class="button button-secondary" data-quick-fact="quiet">Especies Más Silenciosas</button>
        <button class="button button-secondary" data-quick-fact="talkers">Mejores Habladores</button>
        <button class="button button-secondary" data-quick-fact="beginner">Amigable para Principiantes</button>
        <button class="button button-secondary" data-quick-fact="demanding">Más Exigentes</button>
        <button class="button button-secondary" data-quick-fact="small">Loros Pequeños</button>
        <button class="button button-secondary" data-quick-fact="apartment">Apto para Apartamento</button>
      </div>
    </section>

    <!-- Search and Filters -->
    <section class="search-filters" style="max-width: 900px; margin: 0 auto 3rem;">
      <div style="display: grid; gap: 1rem; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));">
        <div class="field-group">
          <label for="species-search">Buscar Especie</label>
          <input
            type="text"
            id="species-search"
            placeholder="Buscar por nombre..."
            style="width: 100%; padding: 0.75rem; border: 1px solid var(--pf-neutral-200); border-radius: var(--pf-radius-soft);"
          />
        </div>

        <div class="field-group">
          <label for="filter-origin">Filtrar por Origen</label>
          <select
            id="filter-origin"
            style="width: 100%; padding: 0.75rem; border: 1px solid var(--pf-neutral-200); border-radius: var(--pf-radius-soft);"
          >
            <option value="">Todas las Regiones</option>
            {origins.map(origin => (
              <option value={origin}>{origin}</option>
            ))}
          </select>
        </div>

        <div class="field-group">
          <label for="filter-loudness">Filtrar por Nivel de Ruido</label>
          <select
            id="filter-loudness"
            style="width: 100%; padding: 0.75rem; border: 1px solid var(--pf-neutral-200); border-radius: var(--pf-radius-soft);"
          >
            <option value="">Todos los Niveles</option>
            <option value="Quiet">Silencioso</option>
            <option value="Moderate">Moderado</option>
            <option value="Loud">Ruidoso</option>
            <option value="Very Loud">Muy Ruidoso</option>
          </select>
        </div>
      </div>

      <div style="margin-top: 1rem; text-align: center; color: var(--pf-neutral-500);">
        <span id="results-count">{allSpecies.length} especies</span>
      </div>
    </section>

    <!-- Species Grid -->
    <div id="species-grid" class="featured-grid" style="gap: 2rem;">
      {sortedSpecies.map((speciesEntry) => (
        <article class="filters-panel__card species-card" data-species={speciesEntry.data.slug}>
          <a href={`/es/species/${speciesEntry.data.slug}`} style="text-decoration: none; color: inherit;">
            <div style="position: relative; aspect-ratio: 3 / 2; overflow: hidden; border-radius: var(--pf-radius-soft); margin-bottom: 1rem; background: var(--pf-neutral-050);">
              <img
                src={speciesEntry.data.image}
                alt={`Loro ${speciesEntry.data.species} de ${speciesEntry.data.origin} - ${speciesEntry.data.size}`}
                loading="lazy"
                decoding="async"
                width="600"
                height="400"
                style="position: absolute; width: 100%; height: 100%; object-fit: contain;"
              />
            </div>

            <h3 style="font-family: var(--pf-font-display); font-size: 1.25rem; margin: 0 0 0.5rem;">
              {speciesEntry.data.species}
            </h3>

            <p style="color: var(--pf-neutral-500); font-size: 0.9rem; margin: 0 0 0.75rem;">
              {speciesEntry.data.category}
            </p>

            <div style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 0.75rem;">
              <span style="padding: 0.25rem 0.5rem; background: var(--pf-neutral-050); border-radius: var(--pf-radius-pill); font-size: 0.85rem;">
                {speciesEntry.data.origin}
              </span>
              <span style="padding: 0.25rem 0.5rem; background: var(--pf-neutral-050); border-radius: var(--pf-radius-pill); font-size: 0.85rem;">
                {speciesEntry.data.size}
              </span>
            </div>

            <p style="color: var(--pf-neutral-600); font-size: 0.95rem; line-height: 1.5; margin: 0;">
              {speciesEntry.data.description.slice(0, 120)}...
            </p>
          </a>
        </article>
      ))}
    </div>
  </main>

  <Fragment slot="scripts">
    <script define:vars={{ serializedSpecies }}>
      const allSpeciesData = JSON.parse(serializedSpecies);
      const grid = document.getElementById('species-grid');
      const searchInput = document.getElementById('species-search');
      const originFilter = document.getElementById('filter-origin');
      const loudnessFilter = document.getElementById('filter-loudness');
      const resultsCount = document.getElementById('results-count');
      const quickFactButtons = document.querySelectorAll('[data-quick-fact]');

      function filterSpecies() {
        const searchTerm = searchInput.value.toLowerCase();
        const selectedOrigin = originFilter.value.toLowerCase();
        const selectedLoudness = loudnessFilter.value.toLowerCase();

        const searchTerms = searchTerm.split(/\s+/).filter(t => t.length > 0);

        let visibleCount = 0;
        const cards = grid.querySelectorAll('.species-card');

        cards.forEach((card) => {
          const slug = card.dataset.species;
          const species = allSpeciesData.find(s => s.slug === slug);
          if (!species) {
            card.style.display = 'none';
            return;
          }

          const matchesSearch = searchTerms.length === 0 || searchTerms.some(term =>
            species.species.toLowerCase().includes(term) ||
            species.category.toLowerCase().includes(term) ||
            species.description.toLowerCase().includes(term)
          );

          const matchesOrigin = !selectedOrigin || species.origin.toLowerCase() === selectedOrigin;
          const matchesLoudness = !selectedLoudness || species.loudness.toLowerCase().startsWith(selectedLoudness);

          if (matchesSearch && matchesOrigin && matchesLoudness) {
            card.style.display = '';
            visibleCount++;
          } else {
            card.style.display = 'none';
          }
        });

        resultsCount.textContent = `${visibleCount} ${visibleCount === 1 ? 'especie' : 'especies'}`;
      }

      searchInput.addEventListener('input', filterSpecies);
      originFilter.addEventListener('change', filterSpecies);
      loudnessFilter.addEventListener('change', filterSpecies);

      // Quick fact buttons
      quickFactButtons.forEach(button => {
        button.addEventListener('click', () => {
          const fact = button.dataset.quickFact;

          // Reset filters
          originFilter.value = '';
          loudnessFilter.value = '';

          // Set search based on fact
          switch(fact) {
            case 'quiet':
              loudnessFilter.value = 'Quiet';
              searchInput.value = '';
              break;
            case 'talkers':
              searchInput.value = 'congo timneh yellow-naped blue-fronted double';
              break;
            case 'beginner':
              searchInput.value = 'cockatiel budgerigar parrotlet lineolated';
              break;
            case 'demanding':
              searchInput.value = 'moluccan umbrella hyacinth';
              break;
            case 'small':
              searchInput.value = 'parrotlet lovebird budgerigar lineolated bourke';
              break;
            case 'apartment':
              searchInput.value = 'bourke budgerigar cockatiel pionus parrotlet lineolated lovebird';
              break;
          }

          filterSpecies();
        });
      });
    </script>
  </Fragment>
</BaseLayout>
