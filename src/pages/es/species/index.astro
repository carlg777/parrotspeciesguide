---
export const prerender = true;
import BaseLayout from "../../../layouts/BaseLayout.astro";
import { getCollection } from 'astro:content';
import { toAbsoluteUrl } from '../../../lib/urlUtils';
import { getLangFromUrl } from "../../../i18n/utils";

// Get current language
const currentLang = getLangFromUrl(Astro.url);

// Get all species
const allSpecies = await getCollection('species');

// Sort alphabetically by species name in current language
const sortedSpecies = allSpecies.sort((a, b) =>
  a.data.species[currentLang].localeCompare(b.data.species[currentLang])
);

// Get unique categories
const categories = [...new Set(allSpecies.map(s => s.data.category))].sort();

// Get unique origins in current language
const origins = [...new Set(allSpecies.map(s => s.data.origin[currentLang]))].sort();

const categoryGroups = categories.map(category => ({
  category,
  slug: category.toLowerCase().replace(/\s+/g, "-"),
  species: sortedSpecies.filter(entry => entry.data.category === category)
}));

// Serialize for client-side filtering
const serializedSpecies = JSON.stringify(sortedSpecies.map(s => s.data)).replace(/</g, '\\u003c');

// ItemList structured data
const speciesListStructuredData = {
  "@context": "https://schema.org",
  "@type": "ItemList",
  "name": "Guías de Cuidado de Especies de Loros",
  "description": "Guías completas de cuidado para 84 especies de loros incluyendo temperamento, dieta, alojamiento e información de salud.",
  "numberOfItems": sortedSpecies.length,
  "itemListElement": sortedSpecies.map((species, index) => ({
    "@type": "ListItem",
    "position": index + 1,
    "url": `https://www.parrotspeciesguide.com/es/species/${species.data.slug}`,
    "name": species.data.species[currentLang],
    "image": toAbsoluteUrl(species.data.image)
  }))
};

const speciesListDataString = JSON.stringify(speciesListStructuredData).replace(/</g, '\\u003c');

const faqStructuredData = {
  "@context": "https://schema.org",
  "@type": "FAQPage",
  "mainEntity": [
    {
      "@type": "Question",
      "name": "¿Cuántas especies de loros hay en esta guía?",
      "acceptedAnswer": {
        "@type": "Answer",
        "text": `Esta guía incluye ${sortedSpecies.length} perfiles detallados de especies de loros.`
      }
    },
    {
      "@type": "Question",
      "name": "¿Puedo filtrar por nivel de ruido?",
      "acceptedAnswer": {
        "@type": "Answer",
        "text": "Sí. Usa el filtro de ruido para encontrar especies silenciosas, moderadas o ruidosas."
      }
    },
    {
      "@type": "Question",
      "name": "¿Hay especies recomendadas para principiantes?",
      "acceptedAnswer": {
        "@type": "Answer",
        "text": "Sí. Usa los botones de Datos Rápidos para ver opciones para principiantes y otros filtros."
      }
    }
  ]
};

const faqDataString = JSON.stringify(faqStructuredData).replace(/</g, '\\u003c');
---

<BaseLayout
  title="Guía de Especies de Loros | Lista Completa de Especies"
  description="Explora perfiles detallados de más de 80 especies de loros. Descubre temperamento, cuidados, nivel de ruido, dieta y alojamiento para cada especie."
  canonical="https://www.parrotspeciesguide.com/es/species"
  ogTitle="Lista Completa de Especies de Loros"
  ogDescription="Encuentra la especie ideal con perfiles de temperamento, cuidados, dieta, ruido y alojamiento."
  dataPage="species"
>
  <Fragment slot="head">
    <script type="application/ld+json" is:inline>
      {speciesListDataString}
    </script>
    <script type="application/ld+json" is:inline>
      {faqDataString}
    </script>
  </Fragment>
  <main class="container page-main page-main--compact">
    <header class="page-header">
      <h1 class="page-title">
        Guía de Especies de Loros
      </h1>
      <p class="page-subtitle">
        Explora {allSpecies.length} especies de loros con información detallada de cuidado
      </p>
    </header>

    <!-- Quick Facts -->
    <section class="section-gap">
      <h2 class="section-title section-title--center">
        Datos Rápidos
      </h2>
      <div class="button-row">
        <button class="button button-secondary" data-quick-fact="quiet">Especies Más Silenciosas</button>
        <button class="button button-secondary" data-quick-fact="talkers">Mejores Habladores</button>
        <button class="button button-secondary" data-quick-fact="beginner">Amigable para Principiantes</button>
        <button class="button button-secondary" data-quick-fact="demanding">Más Exigentes</button>
        <button class="button button-secondary" data-quick-fact="small">Loros Pequeños</button>
        <button class="button button-secondary" data-quick-fact="apartment">Apto para Apartamento</button>
      </div>
    </section>

    <!-- Search and Filters -->
    <section class="search-filters filter-panel">
      <div class="filter-grid">
        <div class="field-group">
          <label for="species-search">Buscar Especie</label>
          <input
            type="text"
            id="species-search"
            placeholder="Buscar por nombre..."
            class="input-control"
          />
        </div>

        <div class="field-group">
          <label for="filter-origin">Filtrar por Origen</label>
          <select
            id="filter-origin"
            class="input-control"
          >
            <option value="">Todas las Regiones</option>
            {origins.map(origin => (
              <option value={origin}>{origin}</option>
            ))}
          </select>
        </div>

        <div class="field-group">
          <label for="filter-loudness">Filtrar por Nivel de Ruido</label>
          <select
            id="filter-loudness"
            class="input-control"
          >
            <option value="">Todos los Niveles</option>
            <option value="Quiet">Silencioso</option>
            <option value="Moderate">Moderado</option>
            <option value="Loud">Ruidoso</option>
            <option value="Very Loud">Muy Ruidoso</option>
          </select>
        </div>
      </div>

      <div class="results-count">
        <span id="results-count">{allSpecies.length} especies</span>
      </div>
    </section>

    <!-- FAQ -->
    <section class="faq-section">
      <h2 class="section-title section-title--center section-title--lg">
        Preguntas Frecuentes sobre Especies de Loros
      </h2>
      <div class="faq-grid">
        <div class="filters-panel__card">
          <h3 class="faq-question">¿Cuántas especies de loros hay en esta guía?</h3>
          <p class="faq-answer">
            Esta guía incluye {sortedSpecies.length} perfiles detallados de especies de loros.
          </p>
        </div>
        <div class="filters-panel__card">
          <h3 class="faq-question">¿Puedo filtrar por nivel de ruido?</h3>
          <p class="faq-answer">
            Sí. Usa el filtro de ruido para encontrar especies silenciosas, moderadas o ruidosas.
          </p>
        </div>
        <div class="filters-panel__card">
          <h3 class="faq-question">¿Hay especies recomendadas para principiantes?</h3>
          <p class="faq-answer">
            Sí. Usa los botones de Datos Rápidos para ver opciones para principiantes y otros filtros.
          </p>
        </div>
      </div>
    </section>

    <!-- Species by Category -->
    <div id="species-grid" class="species-grid">
      {categoryGroups.map(group => (
        <section id={group.slug} class="species-category" data-category={group.category}>
          <h2 class="section-title section-title--lg">
            {group.category}
          </h2>
          <div class="featured-grid species-category__grid">
            {group.species.map((speciesEntry) => (
              <article class="filters-panel__card species-card" data-species={speciesEntry.data.slug}>
                <a href={`/es/species/${speciesEntry.data.slug}`} class="species-card__link">
                  <div class="species-card__media">
                    <img
                      src={speciesEntry.data.image}
                      alt={`Loro ${speciesEntry.data.species[currentLang]} de ${speciesEntry.data.origin[currentLang]} - ${speciesEntry.data.size[currentLang]}`}
                      loading="lazy"
                      decoding="async"
                      width="600"
                      height="400"
                      class="species-card__image"
                    />
                  </div>

                  <h3 class="species-card__title">
                    {speciesEntry.data.species[currentLang]}
                  </h3>

                  <p class="species-card__meta">
                    {speciesEntry.data.category}
                  </p>

                  <div class="species-card__badges">
                    <span class="badge badge--small badge-neutral">
                      {speciesEntry.data.origin[currentLang]}
                    </span>
                    <span class="badge badge--small badge-neutral">
                      {speciesEntry.data.size[currentLang]}
                    </span>
                  </div>

                  <p class="species-card__excerpt">
                    {speciesEntry.data.description[currentLang].slice(0, 120)}...
                  </p>
                </a>
              </article>
            ))}
          </div>
        </section>
      ))}
    </div>
  </main>

  <Fragment slot="scripts">
    <script define:vars={{ serializedSpecies }}>
      const allSpeciesData = JSON.parse(serializedSpecies);
      const grid = document.getElementById('species-grid');
      const searchInput = document.getElementById('species-search');
      const originFilter = document.getElementById('filter-origin');
      const loudnessFilter = document.getElementById('filter-loudness');
      const resultsCount = document.getElementById('results-count');
      const quickFactButtons = document.querySelectorAll('[data-quick-fact]');
      const categorySections = grid.querySelectorAll('.species-category');

      function filterSpecies() {
        const searchTerm = searchInput.value.toLowerCase();
        const selectedOrigin = originFilter.value.toLowerCase();
        const selectedLoudness = loudnessFilter.value.toLowerCase();

        const searchTerms = searchTerm.split(/\s+/).filter(t => t.length > 0);

        let visibleCount = 0;
        const cards = grid.querySelectorAll('.species-card');

        cards.forEach((card) => {
          const slug = card.dataset.species;
          const species = allSpeciesData.find(s => s.slug === slug);
          if (!species) {
            card.style.display = 'none';
            return;
          }

          const matchesSearch = searchTerms.length === 0 || searchTerms.some(term =>
            species.species[currentLang].toLowerCase().includes(term) ||
            species.category.toLowerCase().includes(term) ||
            species.description[currentLang].toLowerCase().includes(term)
          );

          const matchesOrigin = !selectedOrigin || species.origin[currentLang].toLowerCase() === selectedOrigin;
          const matchesLoudness = !selectedLoudness || species.loudness[currentLang].toLowerCase().startsWith(selectedLoudness);

          if (matchesSearch && matchesOrigin && matchesLoudness) {
            card.style.display = '';
            visibleCount++;
          } else {
            card.style.display = 'none';
          }
        });

        resultsCount.textContent = `${visibleCount} ${visibleCount === 1 ? 'especie' : 'especies'}`;

        categorySections.forEach((section) => {
          const sectionCards = section.querySelectorAll('.species-card');
          const hasVisible = Array.from(sectionCards).some(card => card.style.display !== 'none');
          section.style.display = hasVisible ? '' : 'none';
        });
      }

      searchInput.addEventListener('input', filterSpecies);
      originFilter.addEventListener('change', filterSpecies);
      loudnessFilter.addEventListener('change', filterSpecies);

      // Quick fact buttons
      quickFactButtons.forEach(button => {
        button.addEventListener('click', () => {
          const fact = button.dataset.quickFact;

          // Reset filters
          originFilter.value = '';
          loudnessFilter.value = '';

          // Set search based on fact
          switch(fact) {
            case 'quiet':
              loudnessFilter.value = 'Quiet';
              searchInput.value = '';
              break;
            case 'talkers':
              searchInput.value = 'congo timneh yellow-naped blue-fronted double';
              break;
            case 'beginner':
              searchInput.value = 'cockatiel budgerigar parrotlet lineolated';
              break;
            case 'demanding':
              searchInput.value = 'moluccan umbrella hyacinth';
              break;
            case 'small':
              searchInput.value = 'parrotlet lovebird budgerigar lineolated bourke';
              break;
            case 'apartment':
              searchInput.value = 'bourke budgerigar cockatiel pionus parrotlet lineolated lovebird';
              break;
          }

          filterSpecies();
        });
      });
    </script>
  </Fragment>
</BaseLayout>
